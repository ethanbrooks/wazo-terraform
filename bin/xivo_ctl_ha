#!/usr/bin/python

import requests
import sys
import netifaces

xivo_server = "http://localhost:8668"
ip_master = sys.argv[1]
ip_slave = sys.argv[2]

def get_my_ip():
    return netifaces.ifaddresses('eth0')[netifaces.AF_INET][0]['addr']

def get_ha_config():
    return requests.get("{}/get_ha_config".format(xivo_server)).json()

def update_ha_config(node_type='disabled', remote_address=''):
    config = { 'node_type': node_type,
               'remote_address': remote_address
             }
    return requests.post('{}/update_ha_config'.format(xivo_server), json=config)

if get_ha_config()['node_type'] != 'disabled':
    print "Error this XiVO is not a fresh installation"
    sys.exit()

if ip_master in get_my_ip():
    update_ha_config('master', ip_slave)
else:
    update_ha_config('slave', ip_master)
